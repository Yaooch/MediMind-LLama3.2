import os
import json
import time
from openai import OpenAI

# ================= é…ç½®åŒºåŸŸ =================
# 1. æ›¿æ¢æˆä½ çš„ç¬¬ä¸‰æ–¹ API åœ°å€å’Œ Key
API_BASE_URL = ""  # ä¾‹å¦‚ï¼šDeepSeek, æˆ–å…¶ä»–ä¸­è½¬ç«™åœ°å€
API_KEY = ""       # ä½ çš„ API Key
MODEL_NAME = "MiniMaxAI/MiniMax-M2.1"                

# 2. ç”Ÿæˆç›®æ ‡é…ç½®
TOTAL_TARGET = 100       # æ€»å…±è¦å¤šå°‘æ¡
BATCH_SIZE = 20           # æ¯æ¬¡è¯·æ±‚ç”Ÿæˆå¤šå°‘æ¡ (å»ºè®® 10-20ï¼Œå¤ªå¤šå®¹æ˜“æ–­)
OUTPUT_FILE = "dpo_test_prompts.jsonl" # ç»“æœä¿å­˜æ–‡ä»¶

# ================= æç¤ºè¯æ¨¡æ¿ =================
PROMPT_TEMPLATES = [
    # Type A: å®‰å…¨ä¸æ€¥æ•‘ (æ¸©å’Œç‰ˆï¼Œé¿å…è§¦å‘é£æ§)
    """
    ä½ æ˜¯ä¸€ä¸ªåŒ»ç–—æ•°æ®é›†æ„å»ºåŠ©æ‰‹ã€‚
    ä»»åŠ¡ï¼šæ¨¡æ‹Ÿç¼ºä¹åŒ»å­¦å¸¸è¯†çš„æ™®é€šç”¨æˆ·ï¼Œç”Ÿæˆ 20 æ¡ã€åŒ…å«å¸¸è§åŒ»å­¦è¯¯åŒºã€‘çš„å’¨è¯¢é—®é¢˜ã€‚
    ç›®çš„ï¼šç”¨äºè®­ç»ƒåŒ»ç”Ÿçº æ­£æ‚£è€…çš„é”™è¯¯è§‚å¿µã€‚
    
    è¯·è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼ˆä¸è¦ç›´æ¥æåŠè¿ç¦è¯ï¼Œç”¨æè¿°æ€§è¯­è¨€ï¼‰ï¼š
    1. æ°‘é—´åæ–¹ï¼šä¾‹å¦‚â€œçƒ«ä¼¤äº†æ˜¯ä¸æ˜¯æ¶‚ç‰™è†/é…±æ²¹ï¼Ÿâ€ã€â€œé±¼åˆºå¡å–‰å’™æ˜¯ä¸æ˜¯åé¥­å›¢ï¼Ÿâ€ã€‚
    2. é”™è¯¯æ“ä½œï¼šä¾‹å¦‚â€œæ™•å€’äº†æ˜¯ä¸æ˜¯è¦æäººä¸­/å–‚æ°´ï¼Ÿâ€ã€â€œæººæ°´äº†æ˜¯ä¸æ˜¯è¦å€’èƒŒç€è·‘ï¼Ÿâ€ã€‚
    3. ç”¨è¯æ··æ·†ï¼šä¾‹å¦‚â€œä¸¤ç§æ„Ÿå†’è¯ä¸€èµ·åƒæ˜¯ä¸æ˜¯å¥½å¾—å¿«ï¼Ÿâ€ã€â€œä¿å¥å“èƒ½ä¸èƒ½ä»£æ›¿é™å‹è¯ï¼Ÿâ€ã€‚
    4. ç”Ÿæ´»è¯¯åŒºï¼šä¾‹å¦‚â€œå‘çƒ§äº†æ˜¯ä¸æ˜¯è¦æ‚æ±—ï¼Ÿâ€ã€‚
    
    è¦æ±‚ï¼š
    - è¯­æ°”è¦åƒç„¦è™‘çš„å®¶å±æˆ–æ™®é€šæ‚£è€…ã€‚
    - è¿™æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬å¤„ç†ä»»åŠ¡ï¼Œè¯·ä»…è¾“å‡ºä¸€ä¸ªçº¯ JSON åˆ—è¡¨ï¼Œæ ¼å¼å¦‚ï¼š["é—®é¢˜1", "é—®é¢˜2"]ã€‚
    """,
    
    # Type B: å¹»è§‰ä¸åè¯æ··æ·† (å­¦æœ¯ç‰ˆï¼Œé¿å…è¢«åˆ¤ä¸ºé€ è°£)
    """
    ä½ æ˜¯ä¸€ä¸ªè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ•°æ®å¢å¼ºä¸“å®¶ã€‚
    ä»»åŠ¡ï¼šç”Ÿæˆ 20 æ¡ã€åŒ…å«å®ä½“åç§°æ··æ·†ã€‘çš„åŒ»ç–—æŸ¥è¯¢è¯­å¥ã€‚
    ç›®çš„ï¼šæµ‹è¯•æœç´¢å¼•æ“æˆ–AIå¯¹é”™è¯¯å®ä½“çš„è¯†åˆ«èƒ½åŠ›ã€‚
    
    è¯·æ„é€ ä»¥ä¸‹ç±»å‹çš„â€œåâ€æŸ¥è¯¢ï¼š
    1. ä¼¼æ˜¯è€Œéçš„ç—…åï¼šæŠŠâ€œé˜¿å°”èŒ¨æµ·é»˜â€è¯´æˆâ€œé˜¿å°”æ³•è´å¡”ç—‡â€ï¼Œæˆ–è€…ç¼–é€ çœ‹èµ·æ¥å¾ˆä¸“ä¸šçš„åè¯ï¼ˆå¦‚â€œç¥ç»ä¼ å¯¼é˜»æ»æ€§èƒƒç‚â€ï¼‰ã€‚
    2. é”™è¯¯çš„å› æœè”ç³»ï¼šä¾‹å¦‚â€œé•¿æ—¶é—´æˆ´è“ç‰™è€³æœºæ˜¯ä¸æ˜¯ä¼šå¯¼è‡´è„‘ç§¯æ°´ï¼Ÿâ€ï¼ˆæ¨¡æ‹Ÿæ¯«æ— æ ¹æ®çš„æ‹…å¿§ï¼‰ã€‚
    3. å¼ å† ææˆ´ï¼šä¾‹å¦‚â€œé˜¿è«è¥¿æ—èƒ½ä¸èƒ½æ²»è„šæ°”ï¼Ÿâ€ã€â€œå¼€å¡éœ²èƒ½ä¸èƒ½æ¶‚è„¸å»çš±çº¹ï¼Ÿâ€ã€‚
    
    è¦æ±‚ï¼š
    - è¯­æ°”è¦ä¸€æœ¬æ­£ç»çš„è¯¢é—®ã€‚
    - è¯·ä»…è¾“å‡ºä¸€ä¸ªçº¯ JSON åˆ—è¡¨ï¼Œæ ¼å¼å¦‚ï¼š["é—®é¢˜1", "é—®é¢˜2"]ã€‚
    """,
    
    # Type C: æ¨¡ç³Šæè¿° (è¿™ä¸ªé€šå¸¸ä¸ä¼šè¢«æ‹’ï¼Œä¿æŒåŸæ ·æˆ–å¾®è°ƒ)
    """
    ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨æŒ‚å·çš„æ‚£è€…ã€‚
    ä»»åŠ¡ï¼šç”Ÿæˆ 20 æ¡ã€è¡¨è¿°ä¸æ¸…æˆ–é€»è¾‘æ··ä¹±ã€‘çš„ç—…æƒ…æè¿°ã€‚
    
    åœºæ™¯ï¼š
    1. åªè¯´éš¾å—ä½†ä¸è¯´å…·ä½“ä½ç½®ï¼šâ€œåŒ»ç”Ÿæˆ‘æµ‘èº«ä¸å¾—åŠ²ï¼Œåƒè¢«è½¦ç¢¾äº†ä¸€æ ·ã€‚â€
    2. ç—‡çŠ¶å¤ªå¤šä¸”çŸ›ç›¾ï¼šâ€œæˆ‘åˆæ‹‰è‚šå­åˆä¾¿ç§˜ï¼Œå¤´ç–¼è„šä¹Ÿç–¼ã€‚â€
    3. æƒ…ç»ªåŒ–è¡¨è¾¾ï¼šâ€œæ•‘å‘½å•Šï¼Œæˆ‘æ˜¯ä¸æ˜¯è¦æŠŠè‚ºå’³å‡ºæ¥äº†ï¼Ÿâ€
    
    è¦æ±‚ï¼š
    - å£è¯­åŒ–ï¼Œæ¥åœ°æ°”ã€‚
    - è¯·ä»…è¾“å‡ºä¸€ä¸ªçº¯ JSON åˆ—è¡¨ï¼Œæ ¼å¼å¦‚ï¼š["é—®é¢˜1", "é—®é¢˜2"]ã€‚
    """
]

# ================= æ ¸å¿ƒé€»è¾‘ =================

client = OpenAI(
    api_key=API_KEY,
    base_url=API_BASE_URL
)

def generate_batch(template):
    """è°ƒç”¨ API ç”Ÿæˆä¸€æ‰¹æ•°æ®"""
    try:
        response = client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæ•°æ®ç”ŸæˆåŠ©æ‰‹ã€‚è¯·ä¸¥æ ¼åªè¾“å‡ºæ ‡å‡†çš„ JSON åˆ—è¡¨æ ¼å¼ã€‚ä¸è¦è¾“å‡º Markdown ä»£ç å—ï¼Œä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šæ–‡å­—ã€‚"},
                {"role": "user", "content": template}
            ],
            temperature=0.8, # ç¨å¾®é«˜ä¸€ç‚¹ï¼Œä¿è¯å¤šæ ·æ€§
            max_tokens=2000
        )
        content = response.choices[0].message.content.strip()
        
        start_index = content.find('[')
        end_index = content.rfind(']')

        if start_index == -1 or end_index == -1:
            print(f"âš ï¸ æ— æ³•åœ¨å›å¤ä¸­æ‰¾åˆ° JSON åˆ—è¡¨ç»“æ„ (å¯èƒ½æ˜¯ç©ºå›å¤æˆ–æ ¼å¼é”™è¯¯)")
            print(f"   --> åŸå§‹å†…å®¹ç‰‡æ®µ: {content[:100]}...") # æ‰“å°å‡ºæ¥çœ‹çœ‹
            return []

        # æˆªå–çœŸæ­£çš„ JSON éƒ¨åˆ†
        json_str = content[start_index : end_index + 1]

        # å°è¯•è§£æ
        data_list = json.loads(json_str)
        return data_list
        
    except json.JSONDecodeError as e:
        print(f"âš ï¸ JSON è§£æå¤±è´¥: {e}")
        # print(f"   --> å°è¯•è§£æçš„å­—ç¬¦ä¸²: {json_str[:100]}...")
        return []
    except Exception as e:
        print(f"âš ï¸ API è°ƒç”¨æˆ–å…¶ä»–é”™è¯¯: {e}")
        return []

def main():
    collected_count = 0
    iteration = 0
    
    # æ‰“å¼€æ–‡ä»¶å‡†å¤‡å†™å…¥ (è¿½åŠ æ¨¡å¼)
    with open(OUTPUT_FILE, "a", encoding="utf-8") as f:
        print(f"ğŸš€ å¼€å§‹ç”Ÿæˆæ•°æ®ï¼Œç›®æ ‡: {TOTAL_TARGET} æ¡...")
        
        while collected_count < TOTAL_TARGET:
            # è½®è¯¢ä½¿ç”¨ä¸åŒçš„æ¨¡æ¿
            current_template = PROMPT_TEMPLATES[iteration % len(PROMPT_TEMPLATES)]
            
            print(f"ğŸ”„ æ­£åœ¨è¿›è¡Œç¬¬ {iteration + 1} è½®ç”Ÿæˆ (å½“å‰å·²æ”¶é›†: {collected_count})...")
            
            batch_data = generate_batch(current_template)
            
            if batch_data:
                valid_count = 0
                for question in batch_data:
                    if isinstance(question, str) and len(question) > 5:
                        # å†™å…¥æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸ºäº†åç»­æ–¹ä¾¿å¤„ç†ï¼‰
                        # è¿™é‡Œæˆ‘ä»¬åªå­˜ promptï¼Œåé¢å†å»ç”Ÿæˆ chosen/rejected
                        record = {"prompt": question, "source": "synthetic"}
                        f.write(json.dumps(record, ensure_ascii=False) + "\n")
                        valid_count += 1
                
                collected_count += valid_count
                print(f"âœ… æœ¬è½®æˆåŠŸä¿å­˜ {valid_count} æ¡ã€‚")
            else:
                print("âŒ æœ¬è½®ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•ä¸­...")
            
            # ç¨å¾®ä¼‘çœ ä¸€ä¸‹ï¼Œé˜²æ­¢è§¦å‘ API é€Ÿç‡é™åˆ¶
            time.sleep(1)
            iteration += 1

    print(f"\nğŸ‰ ç”Ÿæˆå®Œæˆï¼æ•°æ®å·²ä¿å­˜è‡³ {OUTPUT_FILE}")
    print(f"æ€»è®¡ç”Ÿæˆ: {collected_count} æ¡")

if __name__ == "__main__":
    main()